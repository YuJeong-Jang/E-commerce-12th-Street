# [1] IngressClass (버전 1.x 필수 리소스)
apiVersion: networking.k8s.io/v1
kind: IngressClass
metadata:
  name: nginx
  labels:
    app: frontend-ingress
spec:
  controller: k8s.io/ingress-nginx

---
# [2] 서비스 어카운트
apiVersion: v1
kind: ServiceAccount
metadata:
  name: nginx-ingress-serviceaccount
  namespace: web-proxy

---
# [3] 클러스터 롤 (권한 정의 - ingressclasses 포함)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: nginx-ingress-clusterrole
rules:
  - apiGroups: ["", "networking.k8s.io"]
    resources: ["configmaps", "endpoints", "nodes", "pods", "secrets", "services", "ingresses", "ingresses/status", "ingressclasses"]
    verbs: ["get", "list", "watch", "update", "create", "patch"]
  - apiGroups: ["discovery.k8s.io"]
    resources: ["endpointslices"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "patch"]
  - apiGroups: ["coordination.k8s.io"]
    resources: ["leases"]
    verbs: ["get", "list", "watch", "update", "create", "patch"]

---
# [4] 롤 바인딩 (권한 부여)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: nginx-ingress-clusterrole-nisa-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: nginx-ingress-clusterrole
subjects:
  - kind: ServiceAccount
    name: nginx-ingress-serviceaccount
    namespace: web-proxy

---
# [5] 디플로이먼트 (컨트롤러 실행)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deploy
  namespace: web-proxy
  labels:
    app: frontend-ingress
spec:
  replicas: 2
  selector:
    matchLabels:
      app: frontend-ingress
  template:
    metadata:
      labels:
        app: frontend-ingress
    spec:
      serviceAccountName: nginx-ingress-serviceaccount
      
      # ECR 인증 정보
      imagePullSecrets:
        - name: ecr-cred-nginx
      
      containers:
        - name: controller
          # 빌드해서 올린 팀 이미지 (v1.1)
          image: 820313036770.dkr.ecr.ap-northeast-2.amazonaws.com/web-proxy:v1.1
          imagePullPolicy: Always
          
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: LD_PRELOAD
              value: /usr/local/lib/libmimalloc.so
          
          args:
            - /nginx-ingress-controller
            - --election-id=ingress-controller-leader
            - --controller-class=k8s.io/ingress-nginx
            - --ingress-class=nginx
            - --configmap=$(POD_NAMESPACE)/nginx-config
            - --publish-service=$(POD_NAMESPACE)/nginx-service
            - --watch-ingress-without-class=true
          
          ports:
            - containerPort: 80
            - containerPort: 443
          
          # 헬스체크 (초기 지연 시간 15초로 넉넉하게)
          livenessProbe:
            httpGet:
              path: /healthz
              port: 10254
              scheme: HTTP
            initialDelaySeconds: 15
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /healthz
              port: 10254
              scheme: HTTP
            initialDelaySeconds: 15
            periodSeconds: 10
